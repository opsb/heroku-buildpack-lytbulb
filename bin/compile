#!/usr/bin/env bash

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

# Configure directories
build_dir=$1
cache_dir=$2
env_dir=$3

bp_dir=$(cd $(dirname $0); cd ..; pwd)

source "$bp_dir/bin/common.sh"

installNode()
{
	# Output npm debug info on error
	trap cat_npm_debug_log ERR

	# Look in package.json's engines.node field for a semver range
	semver_range=$(cat $build_dir/app/package.json | $bp_dir/vendor/jq -r .engines.node)

	# Resolve node version using semver.io
	node_version=$(curl --silent --get --data-urlencode "range=${semver_range}" https://semver.io/node/resolve)
	status "Installing node $node_version"

	status "done"
}

addApi()
{
	status "Copying api to build"
	cp -rf $build_dir/api/* $build_dir	
}

installNode
addApi

exit 0